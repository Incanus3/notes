=== Mon, 29.2. ===

- 8-6 - praha
  - makro - reseni podivnych objednavek/uctu/plateb
  - makro - reseni uctovych rout s pepinem - potrebuje se dostat od uctu k datu udalosti
  - servery - reseni problemu s apps po vypadku
  - objednavky - registrace - birth_date pouziva datepicker

- makro - chybna platba - https://rezervace.makro.cz/admin/orders/20189

== Makro ==
- objednavka 1016000094 (20189) - v db cena 6000, ale prislo jen 500
  - v payments logu se skutecne inicializovalo na 6000:
I, [2016-01-14T16:07:45.520978 #7513]  INFO -- : #<PaymentGateway::Payment:0x007f516dad64f0 @order=#<struct PaymentGateway::Order number=1016000094, total_amount=600000, currency="CZK", description="Objednané služby", items=[#<struct PaymentGateway::CartItem name="*** michelin star -", quantity=1, amount=600000, description=nil>]>, @customer=#<struct PaymentGateway::Customer id=nil, language=nil>, @data=nil, @close_immediately=true>
I, [2016-01-14T16:07:46.086198 #7513]  INFO -- : payment initialization succeeded
I, [2016-01-14T16:07:46.086607 #7513]  INFO -- : #<PaymentGateway::Response:0x007f516d57a9e8 @gateway=#<PaymentGateway::Gateway:0x0000000839ac30 @merchant=#<struct PaymentGateway::Merchant id="M1E3CB3273", key=#<PaymentGateway::Merchant::Key:0x0000000839ae38 @key=#<OpenSSL::PKey::RSA:0x0000000839ad20>>>, @uri="https://api.platebnibrana.csob.cz/api/v1", @key=#<PaymentGateway::Gateway::Key:0x0000000807d2a0 @key=#<OpenSSL::PKey::RSA:0x0000000807d1d8>>, @return_url="https://rezervace.makro.cz/payments/handle", @return_method=:post>, @response_hash={"dttm"=>"20160114160746", "signature"=>"AG+cCUxne11Mw9Vfa/m/4jT1EvBi3njMfX9baBlTUFi2cndKqYSTqfB7CwmA6f2LNXUEHe+Pq6Y3+cwiZMDL1vKtmZKb43FTKcNuJ3AUiR/PeR9N4HCiznHR4tyWSdQ+mWROtv57bAQh2GlXbBiUXSffQbcWTRqdQ8+NDJDQI4hhQ3fPz5wEpyto0BcvWuX7dKVrekpjGw5fxcWKuz8QS5Of5tFVdFN8svCaqTD7KUBxo7NgYIcgfzn9gwy9uAQt6ycn2vzuYPMLe+KWi15Q2OkF+YsiAcF3M61LWyyEeWqPArErgNXkWwt/tjISTvI/RoAYBgw91vLkit8nY6SR3Q==", "payId"=>"e7a799e091c23BA", "resultCode"=>0, "resultMessage"=>"OK", "paymentStatus"=>1}, @result=:ok, @payment_status=:initialized, @payment_id="e7a799e091c23BA", @result_message="OK">
I, [2016-01-14T16:08:41.847199 #7513]  INFO -- : processing payment gateway response
I, [2016-01-14T16:08:41.847323 #7513]  INFO -- : payment processing succeeded
I, [2016-01-14T16:08:41.847870 #7513]  INFO -- : #<PaymentGateway::Response:0x007f516e3463b0 @gateway=#<PaymentGateway::Gateway:0x0000000839ac30 @merchant=#<struct PaymentGateway::Merchant id="M1E3CB3273", key=#<PaymentGateway::Merchant::Key:0x0000000839ae38 @key=#<OpenSSL::PKey::RSA:0x0000000839ad20>>>, @uri="https://api.platebnibrana.csob.cz/api/v1", @key=#<PaymentGateway::Gateway::Key:0x0000000807d2a0 @key=#<OpenSSL::PKey::RSA:0x0000000807d1d8>>, @return_url="https://rezervace.makro.cz/payments/handle", @return_method=:post>, @response_hash={"payId"=>"e7a799e091c23BA", "dttm"=>"20160114160836", "resultCode"=>"0", "resultMessage"=>"OK", "paymentStatus"=>"7", "signature"=>"irA2PPlBDW64IbGIVrGcbZo25EDecYQc5slVX7R8uTGvQu0d72BGNnE/J1G8wRpmDzR93Uaug3KKiC93bXicAkAzaf3VQAw/1weLdpyLZHBjbYbMsE4f0voXrG4LZOoAutgofRW3rnDS6TKMxKUjQFBcF2voXGJq+zb68Px+VH3IF1XyPeFXnxwjELpxoVKoifqZyzWf8zBxs+U0X/Q39+txaCxTBA1ybH5m2aGCTbJO6Iq2eA6ZIicqSKE1hncTlE9vxw195NaoBF3pq5HWF15cZR4aiv1W3iX7B0/tHzGdTgTN3HukrdaWY4ZyfcUsuzaLl4bM2KkKU+ax7NDyPw==", "authCode"=>"458115", "controller"=>"payments", "action"=>"handle"}, @result=:ok, @payment_status=:queued, @payment_id="e7a799e091c23BA", @result_message="OK">
  - v xls je u tehle objednavky taky 6k, matouci jsou akorat datumy - 11.2. objednavka vznikla
    (pridanim prvni polozky do kosiku), ale zaplacena byla az 14.2.

- objednavka 1216000004 (20242) - updated_at je pozdejsi, nez kurz, na ktery byla registrace
  - platba byla provedena korektne pred zapocetim kurzu, ucet se ale zapisuje asynchronne a
    background job nejspis nebezel a spustil se az toho 23.2.
  - protoze bg job zapise do objednavky bill_ds_ident (sk_headers.id), aktualizuje updated_at
  - nize je videt, ze zapis uctu je 23.2 (v hranatych zavorkach), ale objednavka ma v te chvili
    updated_at jeste 15.2. (tedy korektne pred probehnutim kurzu):
I, [2016-02-23T15:02:52.019697 #23679]  INFO -- : generating bill for #<Order id: 20242, client_id: 1013070, state: "unpayed", created_at: "2016-02-15 16:40:15", updated_at: "2016-02-15 16:40:15", payment_ident: nil, bill_number: nil, bill_ds_ident: nil, original_order_id: nil>
I, [2016-02-23T15:02:52.039583 #23679]  INFO -- : saving bill
I, [2016-02-23T15:02:52.044792 #23679]  INFO -- : saved
I, [2016-02-23T15:02:52.050315 #23679]  INFO -- : sending bill:
{"header"=>
  {"c_kas"=>-7766,
   "cas_konce"=>Tue, 23 Feb 2016 14:02:52 +0000,
   "order_key"=>20242,
   "sequence"=>"unpayed_bill",
   "typ"=>"Z"},
 "items"=>
  [{"c_karty"=>136676,
    "c_stredisk"=>-7777,
    "dan"=>#<BigDecimal:7f70f91b5640,'0.126E4',9(18)>,
    "dan_sazba"=>#<BigDecimal:7f70f91b5528,'0.21E2',9(18)>,
    "k_odpoctu"=>"Z",
    "mnozstvi"=>#<BigDecimal:7f70f91b5280,'0.1E1',9(18)>,
    "order_item_key"=>294,
    "poradi"=>0,
    "prachy"=>#<BigDecimal:7f70f91b4df8,'0.6E4',9(18)>,
    "prachy_puv"=>#<BigDecimal:7f70f91b4cb8,'0.6E4',9(18)>}],
 "payments"=>
  [{"cena_pl"=>#<BigDecimal:7f70f91b4358,'0.6E4',9(18)>,
    "druh_pl"=>"X_neplacen"}],
 "state"=>"manual",
 "tries"=>0}
I, [2016-02-23T15:02:52.113398 #23679]  INFO -- : bill stored with datastore id 471 and bill number 1216000004

- chybejici objednavka
  - na brane probehlo v obdobi 11.1.-15.1. 9 plateb
  - v db jich je 8, nebot platba s VS 1016000086 ma created_at uz 10.1., komunikace s branou je vsak
    evidovana az 11.1.
  - klient tedy evidentne zacal hazet kurzy do kosiku uz 10., ale objednavku dokoncil a zaplatil az 11.
    [ ] pri platbe znovu kontrolovat, zda kurzy jiz neprobehly
  - po vyfiltrovani v administraci objednavek je jich zobrazeno jen 5 - evidentne chyba filtrovani
    [ ] opravit
