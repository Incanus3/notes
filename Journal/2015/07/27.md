=== Mon, 27.7. ===

- 11.15-12.45 - makro - osetreni chyb pri platbe
  - testovani error handling plateb - zasek na nenalezenych recordech v objednavce - pokud neni
    pouzit nejaky cekajici capybara kod, prohlizec bezi v druhem vlakne jeste pote, co se spusti
    database cleaner

- 3-4.30
  improved error handling in payment#pay_by_card
  - capacity is dealocated on bill generation and payment init failures
  - bill type is changed to F on payment init failure
  - tested
  removed old code

- 11-1
  improved error handling for payments#pay_on_checkout
  - handles bill sending failure
  - Bill#generate, #generate_immediately and #update now take optional order state (defaulting to
    state of given order) which overrides bill type and classes used
    - this way we may generate e.g. unpayed bill (pay_on_checkout) before order state is actually
      changed
  - tested
  renamed Order#recheck_capacity_and_confirm! to #recheck_capacity_and_confirm - removed bang since
    this just returns false in case of insufficient capacity
  added Order#recheck_capacity_and_confirm! - raises Event::InsufficientCapacity
  Order#recheck_capacity_and_confirm! is called before Order#init_payment(!) and #pay_on_checkout(!)
  marked all non-bang Order state changing methods private - most have side effects

  improved error handling for payments#reverse
  - generates bill immediately, handles bill writing failure
  - tested
  - optional order_state is now given to Bill initializer, otherwise it had to be passed all over
    the place
  - removed Bill#fail in favor of Bill#update with 'payment_failed' passed to initializer

= 5h
