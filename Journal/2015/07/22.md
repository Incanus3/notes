=== Wed, 22.7. ===

- 10.30-2.30 - makro - komunikace
  - komunikace s evzou - stavy uctu pri zruseni objednavek
  - komunikace s lucii a pepinem - stavy objednavek po zruseni
  - oprava wice_grid configu po upgradu
  - komunikace s evzou a lucii - castecne zruseni objednavky

- 2.30-7.30 - makro - zapis uctu pred iniciaci platby
  - revize dosavadnich uprav zapisu uctu, potvrzeni objednavky adminem a reverze platby, commit

  - rezervace
    removed gateway accessibility test and payment status actions from PaymentsController

    WIP: generate bill synchronously, update it later; admin payment doesn't go through gateway
    payment by admin doesn't go through payment gateway, just updates order and generates Z bill with
      X_neplacen payment
    - updated mongo-sk-client - added UnpayedAdvanceBill and UnpayedBillPayment
    - added closed_without_payment order state
    - bill and payment class is inferred by Bill#generate from order state
    - renamed payments#pay to #pay_by_card
    - added payments#pay_on_checkout
    - pay button on cart page is now conditional
    - tested
    bill is generated synchronously upon payment initiation, bill number is used as VS
    - updated mongo-sk-client - BillSender is required by gem, more parametrized and exposes
      #send_bill! method
    - added Payment::Bill#generate_immediately which calls this method after saving bill to mongo
      - bill type is set to I here
    - payments#pay_by_card calls this to ensure immediate persisting in ds and setting of
      order.bill_number
    - Payment::Init then uses order.bill_number as VS
    - added Config.datastore.url option, to be passed to BillSender
    payments#handle sets bill type to either Z or F, depending on the payment result
    - updated mongo-sk-client - added BillTypeUpdate, sent as PUT to ds on BillSender#send_bill_update
      and #send_all
    - added bill_ds_ident column to orders table - stores sk_header ds id
    - added Payment::Bill#update - creates BillTypeUpdate, inferrs type from order state
    - called by payments#handle
    refactored Payment::Bill
    updated alto-model-utils - attribute shortcutting no longer upcases shortcuts
    removed ds tables from db schema

    WIP: handled datastore connection error during bill writing
    - Payment::Bill#generate_immediately returns result object
    - payments#pay_by_card handles failure by redirect and flash error
    - refactored bill generation spec
      - extracted BillHelpers and OrderHelpers (non-capybara)
      - moved capybara helpers to subfolder

    added logging of bill generation
    moved Service module out of ServiceContainer module, so that it may be used separately

  - mongo-sk-client
    refactored BillSender._send request body building
    - monkeypatched Mongoid::Document#as_json to remove internal fields and nil values

= 9h
