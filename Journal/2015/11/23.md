=== Mon, 23.11. ===

- 10.30-12 - makro - sepsani blabolu
- 12.30-4 - objednavky - hajek - praha - reseni registraci s Petkou

= 5h

=== Rezervace ===
== Registrace ==
- klient vybere, zda je již registrovaným klientem MAKRO
  - v záporném případě je rovnou přesměrován na registrační formulář, kde zadává pouze osobní údaje,
    klient je vytvořen s client_id a card_id 'non-makro'
  - v kladném případě je přesměrován na formulář pro zadání čísla karty
    - pokud klient zadá platné číslo MAKRO karty, je mu na jeho email, importovaný z db makra,
      zaslán email s odkazem na pokračování registrace
    - zde klient doplní zbytek osobních údajů (formulář je předvyplněn z db makra)
- po úspěšném vyplnění registračního formuláře
  - na základě emailu a hesla, zadaného při registraci, je vytvořen webový uživatel a asociován s
    klientem, pomocí těchto přihlašovacích údajů se pak může klient přihlašovat
  - na email zadaný při registraci je zaslán email s aktivačním odkazem, sloužící k ověření
    vlastnictví emailové schránky klientem

== Klientská část ==
- výchozí stránka aplikace zobrazí (i nepříhlášenému uživateli) seznam událostí, na které se lze
  registrovat, filtrovatelný podle kategorie a měsíce
- po přihlášení pod klientským účtem přibyde možnost registrovat se na některou z událostí
- vytvořením první registrace vzniká objednávka (záznam v tabulce orders) ve stavu (state) 'unpayed'
- s kazdou registrací vzniká záznam v tabulce registrations s daným počtem (count) a příznakem
  potvrzení (confirmed) = false
- po vytvoření všech kýžených registrací může klient kliknutím na tlačítko 'Zaplatit' či navigační
  kartu 'Košík' přejít ke shrnutí objednávky a následné platbě

- při stisku tlačítka 'Zaplatit' (na kartě košíku, nikoli v seznamu událostí) je k objednávce
  nejprve vygenerován (synchronně) doklad s typem 'I' (initialized), a druhem platby
  (sk_payments.druh_pl) 'K_GPE', datastore automaticky přidělí číslo dokladu ze sekvence
  (advance_bill)
- po úspěšném zapsání dokladu zakomunikuje aplikace s API platební brány, čímž inicializuje
  objednávku na straně brány, číslo dokladu se použije jako variabilní symbol platby
- objednávka přechází po úspěšné inicializaci na bráně do stavu 'payment_initialized', registracím
  je nastaven příznak potvrzení na true (po opětovné kontrole volné kapacity událostí)
- klient je poté přesměrován na stránky platební brány, kde zadá udaje ke své platební kartě,
  aplikace čeká na návrat klienta (platební bráně bylo při inicializaci platby předáno URL, na
  které má klienta po dokončení interakce s jejím formulářem přesměrovat zpět)

- po návratu klienta ze stránek platební brány je zpracován výsledek jeho interakce s ní
  - v případě úspěšného zaplacení přechází objednávka do stavu 'payed', typ účtu je aktualizován na 'Z'
  - v případě selhání platby (zadání špatného čísla karty, nedostatečný zůstatek, ...) přechází
    objednávka do stavu 'payment_failed', typ účtu je aktualizován na 'F', příznak potvrzení všech
    registrací objednávky je nastaven na false
  - v případě zrušení platby (kliknutím na příslušný odkaz vedle formuláře platební brány) přechází
    objednávka do stavu 'payment_aborted', typ účtu je aktualizován na 'F', příznak potvrzení ...

- pokud se klient ze stránek platební brány nevrátí (zavře kartu prohlížeče, atp.) je objednávka
  uzavřena po uplynutí půl hodiny (timeout platebního formuláře) automatickým skriptem běžícím v
  pozadí
- ten kontroluje všechny objednávky ve stavu 'payment_initialized' starší než půl hodiny, u každé se
  dotáže platební brány na její aktuální stav a podle toho ji dokončí (změní stav v databázi,
  příznaky potvrzení registrací, typ účtu) stejne jako při návratu klienta z jejích stránek

- klient má možnost prohlížet historii svých objednávek a tisknout z nich zálohové doklady (karta
  'Historie objednávek'), nemůže ovšem své objednávky rušit

== Administrativní část ==
- poté, co administrátor vybere klienta, s jehož účtem bude dále pracovat, probíhá vytváření
  registrací stejně jako v případě klientského přihlášení
- po kliknutí na 'Zaplatit' v košíku ale aplikace nekomunikuje s platební branou
- místo toho pouze (po opětovné kontrole volných míst) změní stav objednávky na
  'closed_without_payment', stav potvrzení registrací na true a vygeneruje zálohový doklad se stavem
  'Z' a druhem platby 'X_neplacen'

- administrátor má v 'Historii objednávek' vybraného klienta možnost úplně nebo částečně zrušit
  existující objednávku
- v tu chvíli vniká nová objednávka ve stavu 'payment_reversed' se zápornými počty a částkami všech
  rušených registrací, k ní je vygenerován zálohový storno doklad s typem 'S' a druhem platby
  'X_neplacen'
- při částečné registraci vzniká storno objednávka nejprve ve stavu 'to_be_reversed' s příznaky
  potvrzení (storno) registrací = false, objednávka přejde do stavu 'payment_reversed' a příznaky
  potvrzení registrací na true v okamžiku potvrzení částečného zrušení, v tomto okamžiku je také
  vygenerován storno doklad
- částečných storno objednávek může vzniknout libovolné množství až do úpleného zrušení všech jejích
  registrací
- k zjistění celkového počtu platných registrací na danou událost je tedy třeba vyhledat všechny
  registrace s příznakem potvrzení = true a daným event_id a posčítat jejich počty, storno
  registrace mají počty záporné

[ ] zdokumentovat ověřovaní volné kapacity při vytvoření (navýšení) registrace a před platbou
[ ] aktualizovat rezervace po zmenach v rails-auth

[ ] počet transakcí zkoumat pouze v případě, že existuje více neregistrovaných klientů se stejným
číslem karty, v případě, že existuje právě jeden neregistrovaný klient, povolit registraci normálně
