=== Tue, 22.4. ===

- prace - alto
  - 6.45-7.15
    - reseni InvalidAuthenticityToken chyby pri snahu o odhlaseni po dlouhe dobe
      https://github.com/evzenk/objednavky/blob/master/doc/invalid_authenticity_token.txt
      - authenticity token se pouziva kvuli CSFR protection, ma omezenou
        platnost
      - protection lze upravit ve volani protect_from_forgery
        (ApplicationController) nebo preskocit before_action
        verify_authenticity_token (SessionsController)

  - 7.15-7.30, 8.15-8.45, 9-10.30, 11.30-12.30
    refactored ClientCanteenRelation
    - it no longer subclasses Struct
    - it stores the client
    - most methods moved from class to instance
    - added .any_exists?(client, canteen), which returns true if client has any
      relation to the canteen
    - .safe_new is no longer needed
    StoredRelation now checks presence of stored_canteen and stored_policy itself
      and no longer checks existence of the relation
    - existence is checked upon login and when placing order
    verification of authenticity token (CSFR protection) is now disabled for logout
    login by card now clears stored relation if invalid or nonexistent
    Client#has_canteen_relation? now ignores type if not specified
    Single and MultiplePortionsController now uses ClientCanteenRelation.any_exists?
      to check that current_client can still order in meal.canteen
    SessionsController was the only user of FailureHandling concern
    - fail_with_alert_t moved there, concern removed
    updated specs

  - 2-2.15
    added spec for Chain
    fixed bug in Chain#has_canteen - don't use find_by!

  - 3-3.15
    added some tests to Client and test notes for others

  - 3.45-4.45
    added test for Client#user_validation
    added test for client expiration date initialization

    Client.has_chain_relation? now ignores type if not given
    added specs for Client
    - find raises Client::NotFound
    - has_canteen_relation?, has_chain_relation?
    - simplified specs for add_canteen_relation, add_chain_relation using ^

  - 5-7.30
    simplified ClientCanteenRelation spec
    added spec for any_exists?

    tested all cases of ClientCanteenRelation#exists?
    - fixed bug - no longer returns true for nonexistent indirect relation if
      direct relation with canteen exists

    simplified ClientRelationsController spec using
      has_canteen_relation? and has_chain_relation?

    added specification, that stored_relation and thus current_relation may no
      longer exist (existence of relation is checked upon login and when placing
      order)

    made 'clear stored relation' and 'login by card' specs faster by mocking
      terminal_canteen instead of registering it

    login by card now works for indirect relations too, closes #33
    - added client_relations and consumers to Chain
    - added CanteenConsumer as abstraction on direct and indirect canteen consumers
    - implements .find(canteen, card_id)
    - used in SessionsController#create_by_card

    tested CanteenConsumer.find
    - find_indirect now returns nil when not found, not []

  - 8.15-9.30
    stored relations are now stored in a hash indexed by client.id

  = 9h


=== Otestovat ===
- Client - dependent specifications for associations - after destroy

=== InvalidAuthenticityToken ===
http://guides.rubyonrails.org/security.html

http://devdocs.io/rails/actioncontroller/requestforgeryprotection/classmethods#method-i-protect_from_forgery

http://stackoverflow.com/questions/7203304/warning-cant-verify-csrf-token-authenticity-rails

skip_before_action :verify_authenticity_token, only: [:destroy]

protect_from_forgery with: :exception, :only/:except => [<action>]
- with options:
  :exception - Raises ActionController::InvalidAuthenticityToken exception.
  :reset_session - Resets the session.
  :null_session - Provides an empty session during request but doesn't reset it
    completely. Used as default if :with option is not specified.
