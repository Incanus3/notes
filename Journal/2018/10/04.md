=== prepocet transakci ===

- pouze spocitani bez updatu
select id, client_id, kind, amount, balance, transacted_at,
       sum(amount) over (partition by client_id, kind order by transacted_at) as new_balance
from transactions

+-----------------------------------------------------------------------------+
| QUERY PLAN                                                                  |
|-----------------------------------------------------------------------------|
| WindowAgg  (cost=73.50..96.22 rows=1010 width=69)                           |
|   ->  Sort  (cost=73.50..76.02 rows=1010 width=37)                          |
|         Sort Key: client_id, kind, transacted_at                            |
|         ->  Seq Scan on transactions  (cost=0.00..23.10 rows=1010 width=37) |
+-----------------------------------------------------------------------------+

- update se subquery, bez predfiltrovani
update transactions
set balance = (select new_balance
               from (select id, sum(amount) over (partition by client_id, kind order by transacted_at) as new_balance from transactions) new_balances
               where new_balances.id = transactions.id)
+-------------------------------------------------------------------------------------------------------------------+
| QUERY PLAN                                                                                                        |
|-------------------------------------------------------------------------------------------------------------------|
| Update on transactions  (cost=0.00..109963.83 rows=1010 width=336)                                                |
|   ->  Seq Scan on transactions  (cost=0.00..109963.83 rows=1010 width=336)                                        |
|         SubPlan 1                                                                                                 |
|           ->  Subquery Scan on new_balances  (cost=73.50..108.85 rows=1 width=32)                                 |
|                 Filter: (new_balances.id = transactions.id)                                                       |
|                 ->  WindowAgg  (cost=73.50..96.22 rows=1010 width=55)                                             |
|                       ->  Sort  (cost=73.50..76.02 rows=1010 width=29)                                            |
|                             Sort Key: transactions_1.client_id, transactions_1.kind, transactions_1.transacted_at |
|                             ->  Seq Scan on transactions transactions_1  (cost=0.00..23.10 rows=1010 width=29)    |
+-------------------------------------------------------------------------------------------------------------------+

- update se subquery, s predfiltrovanim
update transactions
set balance = (select new_balance
               from (select id, sum(amount) over (partition by client_id, kind order by transacted_at) as new_balance
                     from transactions inner_trans
                     where inner_trans.client_ id = transactions.client_id and inner_trans.kind = transactions.kind) new_balances
               where new_balances.id = transactions.id)
+----------------------------------------------------------------------------------------------------------------------------------------------------+
| QUERY PLAN                                                                                                                                         |
|----------------------------------------------------------------------------------------------------------------------------------------------------|
| Update on transactions  (cost=0.00..25490.15 rows=1010 width=336)                                                                                  |
|   ->  Seq Scan on transactions  (cost=0.00..25490.15 rows=1010 width=336)                                                                          |
|         SubPlan 1                                                                                                                                  |
|           ->  Subquery Scan on new_balances  (cost=21.68..25.21 rows=1 width=32)                                                                   |
|                 Filter: (new_balances.id = transactions.id)                                                                                        |
|                 ->  WindowAgg  (cost=21.68..23.95 rows=101 width=55)                                                                               |
|                       ->  Sort  (cost=21.68..21.93 rows=101 width=29)                                                                              |
|                             Sort Key: inner_trans.transacted_at                                                                                    |
|                             ->  Index Scan using transactions_client_id_1fb697bd on transactions inner_trans  (cost=0.28..18.31 rows=101 width=29) |
|                                   Index Cond: (client_id = transactions.client_id)                                                                 |
|                                   Filter: ((kind)::text = (transactions.kind)::text)                                                               |
+----------------------------------------------------------------------------------------------------------------------------------------------------+

- update s CTE
with new_balances as (select id, sum(amount) over (partition by client_id, kind order by transacted_at) as new_balance from transactions)
update transactions set balance = (select new_balance from new_balances wh ere new_balances.id = transactions.id)
+-------------------------------------------------------------------------------------------------------+
| QUERY PLAN                                                                                            |
|-------------------------------------------------------------------------------------------------------|
| Update on transactions  (cost=96.22..23074.10 rows=1010 width=336)                                    |
|   CTE new_balances                                                                                    |
|     ->  WindowAgg  (cost=73.50..96.22 rows=1010 width=55)                                             |
|           ->  Sort  (cost=73.50..76.02 rows=1010 width=29)                                            |
|                 Sort Key: transactions_1.client_id, transactions_1.kind, transactions_1.transacted_at |
|                 ->  Seq Scan on transactions transactions_1  (cost=0.00..23.10 rows=1010 width=29)    |
|   ->  Seq Scan on transactions  (cost=0.00..22977.87 rows=1010 width=336)                             |
|         SubPlan 2                                                                                     |
|           ->  CTE Scan on new_balances  (cost=0.00..22.72 rows=5 width=32)                            |
|                 Filter: (id = transactions.id)                                                        |
+-------------------------------------------------------------------------------------------------------+

- naivni update - bez window funkci a CTE
update transactions set balance = (select sum(amount)
                                   from transactions inner_trans
                                   where inner_trans.client_id = transactions.client_id
                                   and inner_trans.kind = transactions.kind
                                   and inner_trans.transacted_at <= t ransactions.transacted_at)
+--------------------------------------------------------------------------------------------------------------------------------------+
| QUERY PLAN                                                                                                                           |
|--------------------------------------------------------------------------------------------------------------------------------------|
| Update on transactions  (cost=0.00..19132.30 rows=1010 width=336)                                                                    |
|   ->  Seq Scan on transactions  (cost=0.00..19132.30 rows=1010 width=336)                                                            |
|         SubPlan 1                                                                                                                    |
|           ->  Aggregate  (cost=18.91..18.92 rows=1 width=32)                                                                         |
|                 ->  Index Scan using transactions_client_id_1fb697bd on transactions inner_trans  (cost=0.28..18.82 rows=34 width=6) |
|                       Index Cond: (client_id = transactions.client_id)                                                               |
|                       Filter: ((transacted_at <= transactions.transacted_at) AND ((kind)::text = (transactions.kind)::text))         |
+--------------------------------------------------------------------------------------------------------------------------------------+

- materializovane view
create materialized view new_balances as
select id, client_id, kind, amount, balance, transacted_at,
       sum(amount) over (partition by client_id, kind order by transacted_at) as new_balance
from transactions
+----------------------------------------------------------------------------+
| QUERY PLAN                                                                 |
|----------------------------------------------------------------------------|
| WindowAgg  (cost=38.99..49.72 rows=477 width=67)                           |
|   ->  Sort  (cost=38.99..40.18 rows=477 width=35)                          |
|         Sort Key: client_id, kind, transacted_at                           |
|         ->  Seq Scan on transactions  (cost=0.00..17.77 rows=477 width=35) |
+----------------------------------------------------------------------------+

update transactions set balance = (select new_balance from new_balances where new_balances.id = transactions.id)
+--------------------------------------------------------------------------+
| QUERY PLAN                                                               |
|--------------------------------------------------------------------------|
| Update on transactions  (cost=0.00..3434.38 rows=1010 width=336)         |
|   ->  Seq Scan on transactions  (cost=0.00..3434.38 rows=1010 width=336) |
|         SubPlan 1                                                        |
|           ->  Seq Scan on new_balances  (cost=0.00..3.38 rows=1 width=6) |
|                 Filter: (id = transactions.id)                           |
+--------------------------------------------------------------------------+

- s vyuctovanimi
1) rozgrupovani podle vyuctovani
create materialized view groups_by_settlement as
select id, transacted_at, description, client_id, kind, amount, balance,
       count(*) filter (where description = 'VYUCT')
                over (partition by client_id, kind order by transacted_at rows between unbounded preceding and 1 preceding)
                as group_num
from transactions

2)
