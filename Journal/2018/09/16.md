==== rozdeleni modelu mezi appky ====

- presun produktu do sk
  - vyhody (velmi marginalni, druha je spis otrava, protoze appku uz jsme stejne pridali na obou stranach)
    - fkey BillItem.product nejde pres hranici appky
    - nebudeme zatim potrebovat food appku
  - nevyhody
    - jestli nejaky model patri jasne do foodu, pak jsou to produkty, vsechno ostatni stavi na nich
    - do Produktu chceme pridat identifikaci foodu, to ale nedava smysl, pokud jsou produkty
      soucasti sk a na foodu by teoreticky nemely byt zavisle
    - je dost pravdepodobne, ze pokud se ted presune, bude se v budoucnu presouvat zase zpatky


BillItem.objects.all()
  .annotate(c_data = F('header__c_data'))
  .update(product_id = Subquery(
    Product.objects
      .filter(range_id = OuterRef('c_data'), stock_card_number = OuterRef('c_karty'))
      .values('id')[:1]))


UPDATE sk_items SET product_id = (
  SELECT id FROM products
    WHERE products.stock_card_number = sk_items.c_karty
    AND products.range_id = (SELECT c_data FROM sk_headers WHERE id = sk_items.header_id))

h1. Custom routy

h2. Zapis uctu

<pre>POST, PUT a PATCH /sk/crud/bill_items</pre>

* model @BillItem@ ma nove sloupec @c_data@ (puvodne byl v @BillHeader@, nove zde jako fkey na @ProductRange.id@) a @product@ (fkey na @Product.id@)
* sloupec @c_data@ neni povinny, v pripade vynechani se doplni default - bud @ProductRange@ se jmenem 'default' (vytvoreny migraci), nebo s nejnizsim @id@, pokud neni default
* jak sloupec @product@, tak kombinace sloupcu @c_data@ a @c_karty@ slouzi k identifikaci produktu (skladove karty) novym, resp. starym zpusobem
* generickym routam pro zapis a update plozky uctu lze predat bud @product@ (@c_data@ a @c_karty@ se doplni), nebo nakopak kombinaci @c_data@ a @c_karty@ (@product@ se doplni),
prip. oboji (vrati 400 pokud hodnoty vzajemne neodpovidaji)
* do budoucna je sikovne pouzivat novy zpusob (pole @product@), az bude vsude, muzou se sloupce @c_data@ a @c_karty@ odstranit

<pre>POST /sk/write_bill</pre>

* zapise kompletni ucet
* povinne parametry: @header@ (dict fieldu pro @BillHeader@), @items@ (pole dictu s fieldy pro @BillItem@), @payments@ (pole dictu s fieldy pro @BillPayment@)
* pro dicty s fieldy pro @BillItem@ plati vyse uvedene body pro genericke routy
* krome toho lze v dictu pro @header@ zahrnout i pole @c_data@, ktere se pouzije jako default pro polozky, ktere samy nespecifikuji, jinak se opet pouzije globalni default (viz vyse)
