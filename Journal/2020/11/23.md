== covid-form ==
=== postupne otevirani slotu ===

- CF::Services::Capacity#available_time_slots_for(date) potrebuje time sloty
  1) s volnejma kapacitama na date (parametr date)
  2) s pridanym sloupcem s casovymi rozsahy (parametr remove_leading_zeros)
- metody repozitaru ale nejsou chainable, takze
  - bud musi byt jedna metoda repa, ktera resi 1 i 2, pak
    - bud bude mit nazev, ktery odpovida podobe dat (napr.
      available_for_date_with_time_ranges(date, remove_leading_zeros: true),
      ale pak bude je nazev kilometrovy a smesuje parametry, ktere spolu nesouvisi
    - nebo bude mit nazev, ktery odpovida use-casu, napr.
      available_for_registration_for(date) (vi, ze rlz ma byt true),
      ale pak vi persistencni vrstva o domenove logice, coz je spatne
  - nebo bude servica pracovat primo s relationami, coz je sice lehky abstraction leak z
    persistencni vrstvy, ale mozna je to mensi zlo, nez predchozi dva problemy




module Relations
  class Registrations < ROM::Relation[:sql]
    schema(:registrations, infer: true) do
      associations do
        belongs_to :client
        belongs_to :time_slot
      end
    end

    def for_date(date)
      where(exam_date: date)
    end

    def counts_by_slot
      select { [time_slot_id, integer.count(id).as(:registration_count)] }
        .group(:time_slot_id)
        .order(nil)
    end
  end
end

module Repositories
  class Registrations < ROM::Repository
    def counts_for_date(date)
      counts_by_slot = registrations.for_date(date).counts_by_slot

      p time_slots.left_join(counts_by_slot)
    end
  end
end
